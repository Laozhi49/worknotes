
在树莓派上使用 `ros2 bag record` 失败，**确实常见于内存或存储空间不足**的问题，但也可能是 CPU、磁盘 I/O、权限或 SD 卡写入速度导致的。我们可以一步步确认原因。

---

## 🧩 一、常见失败原因汇总

| 原因               | 说明                             | 检查方法               |
| ---------------- | ------------------------------ | ------------------ |
| 💾 **磁盘空间不足**    | rosbag 会持续写入数据，容易把 SD 卡写满      | `df -h`            |
| 🧠 **内存（RAM）不足** | 录制大量话题（尤其是图像）时，缓冲区会爆           | `free -h` 或 `htop` |
| 🧮 **CPU过载**     | 压缩写入/同步IO太慢导致 dropped messages | `top`              |
| 🔒 **文件系统或权限问题** | 没有写权限或路径不存在                    | 检查输出路径权限           |
| ⚡ **SD卡写入速度太慢**  | rosbag写入太快导致 I/O bottleneck    | `iostat` 或 `iotop` |

---

## 🧠 二、查看内存使用情况

你可以在终端执行以下命令：

### 1️⃣ 查看总体内存占用

```bash
free -h
```

输出示例：

```
              total        used        free      shared  buff/cache   available
Mem:           3.8G        2.5G        300M        120M        1.0G        900M
Swap:          1.0G        400M        600M
```

👉 关键看：

* `available`：剩余可用内存（如果小于几百 MB，容易崩）
* `Swap`：若 swap 被大量占用，说明内存确实不够用。

---

### 2️⃣ 实时监控资源使用

```bash
htop
```

或简化版：

```bash
top
```

* 绿色条：内存使用
* 黄色条：CPU负载
* 按 `M` 可以按内存排序。

---

### 3️⃣ 查看磁盘剩余空间

```bash
df -h
```

输出示例：

```
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        29G   27G  300M  99% /
```

如果 `Avail` 剩余空间小于 1G，就很可能导致 rosbag 写失败。

---

## 🪫 三、定位 ros2 bag record 的具体错误

录制命令：

```bash
ros2 bag record -a
```

失败时的输出信息很关键。常见错误如下：

| 错误信息                      | 原因                     |
| ------------------------- | ---------------------- |
| `No space left on device` | 存储空间不足                 |
| `Bad file descriptor`     | 路径错误或 I/O 异常           |
| `std::bad_alloc`          | 内存不足（RAM 爆）            |
| `Segmentation fault`      | rosbag 内部崩溃（通常由内存不足引起） |
| `Failed to write message` | 写入太慢或被系统杀死（可能 OOM）     |

---

## 🧰 四、建议与优化措施

1. **减少录制的话题数**

   ```bash
   ros2 bag record /odom /scan /cmd_vel
   ```

   不要用 `-a`，只录关键话题。

2. **使用外接 SSD 或高速 U 盘**

   * SD 卡写入速度太慢会造成 rosbag buffer 溢出。
   * 可以挂载到 `/media/pi/SSD` 并在那录制。

3. **启用压缩录制**

   ```bash
   ros2 bag record -a --compression-mode file --compression-format zstd
   ```

   但注意压缩会增加 CPU 占用。

4. **监控内存实时变化**

   ```bash
   watch -n 1 free -h
   ```

   每秒刷新一次。

5. **开启交换分区（SWAP）**
   如果你内存是 2G 或 4G，可增加 swap 大小：

   ```bash
   sudo dphys-swapfile swapoff
   sudo nano /etc/dphys-swapfile
   ```

   把：

   ```
   CONF_SWAPSIZE=1024
   ```

   改成 2048 或更大，然后：

   ```bash
   sudo dphys-swapfile setup
   sudo dphys-swapfile swapon
   ```

---
